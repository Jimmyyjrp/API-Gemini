from google import genai
from linebot import LineBotApi, WebhookHandler
from linebot.models import TextSendMessage, MessageEvent, TextMessage
from flask import Flask, request, abort
from linebot.models import FlexSendMessage, BubbleContainer, ImageComponent, BoxComponent, TextComponent, URIAction
import re


# LINE API Access Token ‡πÅ‡∏•‡∏∞ Channel Secret
CHANNEL_ACCESS_TOKEN = 'rLoSpWjE4tJlrvLQXZN1ki7c9oWmvjJ+jNrtEnp7h80oh4D3GauvvdIOug9fEDeLbx7opxXfRBVmsxS57K2eh2tITggJuBJ5XxhNFLMumNK/pkaxfxZ7mh7o20pWMixtdK2IcqvHAioxIMrpRrHj7wdB04t89/1O/w1cDnyilFU='
CHANNEL_SECRET = 'fff648004304c3a6bcde6c056eecd810'

# ‡∏™‡∏£‡πâ‡∏≤‡∏á client ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Gemini API
client = genai.Client(api_key="AIzaSyCMra2j44ztGyuTP8MzkJirs1TFtzuHpmo")

# ‡∏™‡∏£‡πâ‡∏≤‡∏á LineBotApi ‡πÅ‡∏•‡∏∞ WebhookHandler
line_bot_api = LineBotApi(CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(CHANNEL_SECRET)

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Flask app
app = Flask(__name__)

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Gemini API
user_message = "‡∏Ç‡∏≠‡∏≠‡∏µ‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏¥"
current_genre = "‡πÅ‡∏ô‡∏ß‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞"  # ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ß‡πâ
def generate_answer(user_message):
    prompt = f""" 
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞ ‡πÄ‡∏û‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞,‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ô‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ  ,‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡∏°‡∏≤‡∏Å ‡πÜ ‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î‡∏à‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ  
‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏´‡∏≤‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞ ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ü‡∏±‡∏á ‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏∏‡∏ó‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡∏à‡∏ô‡∏£‡∏Å‡∏ô‡∏∞)  

‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡πÅ‡∏ô‡∏ß {current_genre} ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤ {user_message}
‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡∏≠‡∏µ‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß {current_genre} ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏ô‡∏ß {current_genre} ‡∏à‡∏≤‡∏Å‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ô‡∏ß {current_genre}
‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ô‡∏µ‡πâ

‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏ô‡∏∞‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ô‡∏µ‡πâ
‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢: ‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏µ ‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÇ‡∏ó‡∏ô/‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢
‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ô‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ô‡∏ß (2-3 ‡πÅ‡∏ô‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÇ‡∏î‡∏ô‡πÉ‡∏à)
‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤ "‡∏Ç‡∏≠‡∏≠‡∏µ‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", "‡∏≠‡∏µ‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á", ‡∏´‡∏£‡∏∑‡∏≠ "‡∏°‡∏µ‡∏≠‡∏µ‡∏Å‡πÑ‡∏´‡∏°" ‚Üí ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥

‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥
‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞ ‡πÄ‡∏û‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ô‡∏∏‡∏Å ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á
‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡πÄ‡∏û‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡πÉ‡∏´‡∏°‡πà‡πÜ ‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á  ‡πÇ‡∏ó‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£/‡∏Ñ‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡πÄ‡∏ó‡∏û , ‡∏ô‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏ú‡∏°‡πÄ‡∏á‡∏¥‡∏ô ,‡∏ï‡∏±‡∏ß‡∏£‡πâ‡∏≤‡∏¢‡πÄ‡∏ó‡πà ,‡∏û‡∏£‡∏∞‡∏£‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏≤‡∏£ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πá‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á ‡πÅ‡∏ô‡∏ß‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô
‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏µ:
- ‚Äú‡πÇ‡∏≠‡πâ‡∏¢‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏ô‡πà‡πÄ‡∏•‡∏¢ üí•‚Äù
- ‚Äú‡πÄ‡∏≠‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏±‡∏á‡∏≠‡πà‡∏∞ ‡∏ü‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏ô‡∏•‡∏∏‡∏Å!‚Äù
- ‚Äú‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏°‡∏≤‡∏Å ‡πÜ ‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏Ñ‡∏•‡∏≠‡∏≠‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ü•π‚Äù
‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:
‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á, ‡πÅ‡∏ô‡∏ß, ‡∏õ‡∏µ, ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•, ‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå (‡πÄ‡∏ä‡πà‡∏ô MyAnimeList ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏≤‡πÑ‡∏î‡πâ)
‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏•‡∏á: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á, ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô, ‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£, ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÄ‡∏û‡∏•‡∏á, ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à: ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÜ

‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ‚Äú{user_message}‚Äù
"""
    response = client.models.generate_content(
        model="gemini-2.0-flash",
        contents=[prompt]
    )
    return response.text


# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_message = event.message.text
    user_id = event.source.user_id

    print(f"Received message: {user_message} from {user_id}")

    # ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏ß‡∏à‡∏µ‡∏ö
    flirting_keywords = [
        "‡∏°‡∏µ‡πÅ‡∏ü‡∏ô‡∏¢‡∏±‡∏á", "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÅ‡∏ü‡∏ô‡∏¢‡∏±‡∏á", "‡∏à‡∏µ‡∏ö‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°", "‡∏à‡∏µ‡∏ö‡πÑ‡∏î‡πâ‡∏°‡∏±‡πâ‡∏¢", "‡πÇ‡∏™‡∏î‡πÑ‡∏´‡∏°", "‡πÅ‡∏ü‡∏ô‡∏¢‡∏±‡∏á", 
        "‡∏ï‡∏Å‡∏´‡∏•‡∏∏‡∏°‡∏£‡∏±‡∏Å", "‡∏Ñ‡∏∏‡∏ì‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å", "‡∏ä‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì", "‡∏ä‡∏≠‡∏ö‡∏ö‡∏≠‡∏ó", "‡∏ö‡∏≠‡∏ó‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å", "‡∏à‡∏µ‡∏ö‡∏ö‡∏≠‡∏ó"
    ]

    if any(keyword in user_message.lower() for keyword in flirting_keywords):
        cute_reply = "‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡πà‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡πÇ‡∏≠‡∏∞ ‡∏à‡∏µ‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö‡∏ú‡∏°"
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=cute_reply))
        return

    # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏´‡∏≤ Gemini API
    answer = generate_answer(user_message)

    # ‡∏•‡∏ö Markdown ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    clean_answer = re.sub(r"\*+", "", answer)
    clean_answer = re.sub(r"\[(.*?)\]\((.*?)\)", r"\1\n\2", clean_answer)

    # 1. ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å Gemini ‡∏°‡∏≤‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ raw_answer
    raw_answer = response.text  # ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà Gemini ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    
    # 2. ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
    clean_answer = re.sub(r"[^\S\r\n]*‡∏ä‡∏∑‡πà‡∏≠[ ]?‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á[ ]*:[^\S\r\n]*", "üé¨ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ", raw_answer, flags=re.IGNORECASE)
    clean_answer = re.sub(r"[^\S\r\n]*‡πÅ‡∏ô‡∏ß[ ]*:[^\S\r\n]*", "üß≠ ‡πÅ‡∏ô‡∏ß: ", clean_answer, flags=re.IGNORECASE)
    clean_answer = re.sub(r"[^\S\r\n]*‡∏õ‡∏µ[ ]*:[^\S\r\n]*", "üìÖ ‡∏õ‡∏µ: ", clean_answer, flags=re.IGNORECASE)
    clean_answer = re.sub(r"[^\S\r\n]*‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•[ ]*:[^\S\r\n]*", "‚ù§Ô∏è ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ", clean_answer, flags=re.IGNORECASE)
    clean_answer = re.sub(r"[^\S\r\n]*‡∏•‡∏¥‡∏á‡∏Å‡πå[ ]*:[^\S\r\n]*", "üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå: ", clean_answer, flags=re.IGNORECASE)
    clean_answer = re.sub(r"[^\S\r\n]*‡∏ä‡∏∑‡πà‡∏≠[ ]?‡πÄ‡∏û‡∏•‡∏á[ ]*:[^\S\r\n]*", "üé∂ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á: ", clean_answer, flags=re.IGNORECASE)
    clean_answer = re.sub(r"[^\S\r\n]*‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô[ ]*:[^\S\r\n]*", "üé§ ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô: ", clean_answer, flags=re.IGNORECASE)
    clean_answer = re.sub(r"[^\S\r\n]*‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á[ ]*:[^\S\r\n]*", "üé¨ ‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ", clean_answer, flags=re.IGNORECASE)
    clean_answer = re.sub(r"[^\S\r\n]*‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå[ ]?‡πÄ‡∏û‡∏•‡∏á[ ]*:[^\S\r\n]*", "üéß ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÄ‡∏û‡∏•‡∏á: ", clean_answer, flags=re.IGNORECASE)

# 3. ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏° URL ‡πÄ‡∏û‡∏•‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
song_url = "https://www.youtube.com/watch?v=6zQ1kYxHfFw"  # ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠ Gemini ‡∏Å‡πá‡πÑ‡∏î‡πâ
if "üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏•‡∏á:" not in clean_answer:
    clean_answer += f"\nüîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏•‡∏á: {song_url}"


    # ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE
    response_message = f"{clean_answer}"
    line_bot_api.reply_message(event.reply_token, TextSendMessage(text=response_message))



# Webhook URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å LINE
@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)

    try:
        handler.handle(body, signature)
    except Exception as e:
        print("Error:", e)
        abort(400)

    return 'OK'

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=5000)
